name: Sync and Summarize FE News

on:
  schedule:
    - cron: '0 0 10 * *'  # ë§¤ì›” 10ì¼ 00:00 UTC (í•œêµ­ì‹œê°„ ì˜¤ì „ 9ì‹œ)
  workflow_dispatch:      # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout forked repo
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Set up Git
        run: |
          git config user.name "SuKyoung Shin"
          git config user.email "sukyoung.dev@gmail.com"

      - name: Add upstream and fetch
        run: |
          git remote | grep upstream || git remote add upstream https://github.com/naver/fe-news
          git fetch upstream

      - name: Merge upstream changes
        run: |
          git checkout master
          git merge upstream/master --allow-unrelated-histories -m "Sync with upstream naver/fe-news"

      - name: Push changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} master

  summarize:
    runs-on: ubuntu-latest
    needs: sync  # sync ì™„ë£Œ í›„ ì‹¤í–‰
    steps:
      - name: Get current year and month
        run: echo "YEAR_MONTH=$(date +'%Y-%m')" >> $GITHUB_ENV

      - name: Download FE News issue markdown
        run: |
          curl -s "https://raw.githubusercontent.com/naver/fe-news/master/issues/${YEAR_MONTH}.md" -o news.md

      - name: Extract top 10 items
        run: |
          grep '^-' news.md | head -n 10 > summary.txt

      - name: Send Telegram Summary
        run: |
          MONTH=$(date +'%m' | sed 's/^0*//')ì›”
          SUMMARY=$(cat summary.txt)

          # ì²« ë²ˆì§¸ ë©”ì‹œì§€: "ë°©ê¸ˆ ë„ì°©í–ˆì–´ìš”!"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode "text=ğŸ“® ${MONTH}ì˜ Naver/FeNewsê°€ ë°©ê¸ˆ ë„ì°©í–ˆì–´ìš”!"

          # ë‘ ë²ˆì§¸ ë©”ì‹œì§€: ìš”ì•½ ë‚´ìš© (ì¤„ë°”ê¿ˆì€ \n ì‚¬ìš©)
          MESSAGE="ğŸ“° ${MONTH} FE News ìš”ì•½\n\n${SUMMARY}\n\nğŸ”— ì „ì²´ ë³´ê¸°: https://github.com/naver/fe-news/blob/master/issues/${YEAR_MONTH}.md"

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            --data-urlencode "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            --data-urlencode "text=$MESSAGE"
